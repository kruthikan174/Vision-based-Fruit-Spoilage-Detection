<!DOCTYPE html>
<html>
<head>
    <title>Environment Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f5f9ff; font-family: 'Segoe UI', sans-serif; padding: 30px; }
        .chart-frame { width: 100%; height: 260px; border-radius: 10px; border: none; }
        .section-title { margin-top: 40px; margin-bottom: 10px; }
        .status-dot { width: 20px; height: 20px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .dot-green { background-color: #28a745; }
        .dot-red { background-color: #dc3545; }
        .card-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        canvas { width: 100%; height: 160px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">🍌 Banana Freshness</a>
            <a class="nav-link" href="/environment">🌡️ Environment</a>
        </div>
    </nav>

    <div class="container text-center">
        <h2>📊 Environment & Stock Monitoring</h2>

        <!-- Dashboard Cards -->
        <div class="row text-center mt-4">
            <div class="col-md-3"><div class="card-box">🌡️ <h5>Temp</h5><p id="val-temp">-- °C</p></div></div>
            <div class="col-md-3"><div class="card-box">💧 <h5>Humidity</h5><p id="val-hum">-- %</p></div></div>
            <div class="col-md-3"><div class="card-box">🧪 <h5>Gas</h5><p id="val-gas">-- ppm</p></div></div>
            <div class="col-md-3">
                <div class="card-box">📦 <h5>Stock</h5>
                    <span id="stock-status" class="status-dot dot-red"></span>
                    <span id="stock-text">Alert</span>
                </div>
            </div>
        </div>

        <!-- Gauge -->
        <div class="my-5">
            <h5 class="section-title">🧭 Live Gas Meter</h5>
            <canvas id="gasGauge" width="300" height="160"></canvas>
        </div>

        <!-- Graphs -->
        <!-- Row 1: Temperature & Humidity -->
<div class="row">
    <div class="col-md-6 mb-4">
        <h5 class="section-title">🌡️ Temperature</h5>
        <iframe class="chart-frame"
            src="https://thingspeak.com/channels/{{ channel_id }}/charts/1?api_key={{ api_key }}&dynamic=true&type=line&title=Temperature">
        </iframe>
    </div>
    <div class="col-md-6 mb-4">
        <h5 class="section-title">💧 Humidity</h5>
        <iframe class="chart-frame"
            src="https://thingspeak.com/channels/{{ channel_id }}/charts/2?api_key={{ api_key }}&dynamic=true&type=line&title=Humidity">
        </iframe>
    </div>
</div>

<!-- Row 2: Gas & Stock -->
<div class="row">
    <div class="col-md-6 mb-4">
        <h5 class="section-title">🧪 Gas Levels</h5>
        <iframe class="chart-frame"
            src="https://thingspeak.com/channels/{{ channel_id }}/charts/3?api_key={{ api_key }}&dynamic=true&type=line&title=Gas+Levels">
        </iframe>
    </div>
    <div class="col-md-6 mb-4">
        <h5 class="section-title">📦 Stock Status</h5>
        <iframe class="chart-frame"
            src="https://thingspeak.com/channels/{{ channel_id }}/charts/4?api_key={{ api_key }}&dynamic=true&type=line&title=Stock+Status">
        </iframe>
    </div>
</div>

    </div>

    <script src="https://bernii.github.io/gauge.js/dist/gauge.min.js"></script>
    <script>
        const opts = {
            angle: 0.15,
            lineWidth: 0.44,
            radiusScale: 1,
            pointer: { length: 0.6, strokeWidth: 0.035, color: '#000000' },
            limitMax: false,
            limitMin: false,
            colorStart: '#6FADCF',
            colorStop: '#8FC0DA',
            strokeColor: '#E0E0E0',
            generateGradient: true,
            highDpiSupport: true
        };
        const target = document.getElementById('gasGauge');
        const gauge = new Gauge(target).setOptions(opts);
        gauge.maxValue = 100;
        gauge.setMinValue(0);
        gauge.animationSpeed = 32;

        async function fetchLatest() {
            try {
                const res = await fetch("https://api.thingspeak.com/channels/{{ channel_id }}/feeds.json?api_key={{ api_key }}&results=1");
                const data = await res.json();
                const latest = data.feeds[0];
                const temp = parseFloat(latest.field1);
                const hum = parseFloat(latest.field2);
                const gas = parseFloat(latest.field3);
                const stock = parseFloat(latest.field4);

                document.getElementById('val-temp').textContent = temp.toFixed(1) + " °C";
                document.getElementById('val-hum').textContent = hum.toFixed(1) + " %";
                document.getElementById('val-gas').textContent = gas.toFixed(1) + " ppm";
                document.getElementById('stock-status').className = "status-dot " + (stock > 50 ? "dot-green" : "dot-red");
                document.getElementById('stock-text').textContent = stock > 50 ? "OK" : "Alert";

                gauge.set(gas);
            } catch (err) {
                console.error("Error loading data:", err);
            }
        }

        fetchLatest();
        setInterval(fetchLatest, 15000);
    </script>
</body>
</html>
